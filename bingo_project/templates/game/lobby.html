{% extends 'base.html' %}
{% load game_filters %}
{% load static %}

{% block title %}Lobby - {{ room.code }}{% endblock %}

{% block header %}
<div id="connection-status" class="badge badge-warning" title=' "ROOM" Connection status'>Connecting...</div>
{% endblock %}

{% block extra_css %}
<style>
    .tooltip-container { position: relative; display: inline-flex; }
    .tooltip-content {
        visibility: hidden;
        width: 220px;
        background-color:  #1e293b;
        color: #fff;
        text-align: left;
        border-radius: 8px;
        padding: 10px 12px;
        position: fixed;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
        font-size: 12px;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tooltip-content:: after {
        content: "";
        position: absolute;
        top:  100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
    }
    .tooltip-container:hover .tooltip-content { visibility: visible; opacity: 1; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">

    <!-- Notification Container -->
    <div id="notification-container-top" class="fixed top-20 right-4 z-50 space-y-2 max-w-xs"></div>
    <div id="notification-container-bottom" class="fixed bottom-20 left-0 z-50 space-y-2 max-w-xs"></div>
    
    <!-- Main Content -->
    <main class="flex-1 py-8 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Left Column:  Room Info & Share -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Room Code Card -->
                    <div class="card p-6 relative">

                        <!-- Room Settings Button -->
                        <span id="room-settings" onclick="OpenCloseSettings()" class="absolute -top-3 -right-2 p-1 bg-green-100 border border-green-300 text-green-900 rounded-full cursor-pointer" title="Room Settings">
                            <svg class="w-5 h-5 hover:rotate-90 transition-transform" viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' >
                                <g transform="matrix(0.43 0 0 0.43 12 12)" >
                                    <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-25, -25)" d="M 22.205078 2 C 21.71554465145752 2.0002592913348565 21.29814891331823 2.354839071557026 21.21875 2.837890600000001 L 20.246094 8.7929688 C 19.076509 9.1331971 17.961243 9.5922728 16.910156 10.164062 L 11.996094 6.6542969 C 11.598816673690413 6.370610351017056 11.05478010183534 6.41518993627862 10.708984 6.7597656 L 6.8183594 10.646484 C 6.475160524964622 10.989923106498557 6.428211573453509 11.530247517776324 6.7070312 11.927734 L 10.164062 16.873047 C 9.583454 17.930271 9.1142098 19.051824 8.765625 20.232422 L 2.8359375 21.21875 C 2.3544384236683737 21.299853103126054 2.0018943636724598 21.71679624691585 2.0019531 22.205078 L 2.0019531 27.705078 C 2.0010727236635546 28.190255593235108 2.3485550930543897 28.606081573468177 2.8261718999999994 28.691406 L 8.7597656 29.742188 C 9.1064607 30.920739 9.5727226 32.043065 10.154297 33.101562 L 6.6542969 37.998047 C 6.370610922069476 38.3953241278578 6.415190488284029 38.93936004458805 6.7597656 39.285156 L 10.648438 43.175781 C 10.991091175572949 43.518528734926946 11.53018449205332 43.566265169641206 11.927734 43.289062 L 16.882812 39.820312 C 17.936999 40.39548 19.054994 40.857928 20.228516 41.201172 L 21.21875 47.164062 C 21.29900191650291 47.64633753510371 21.716171003072734 47.99989891822272 22.205078 48 L 27.705078 48 C 28.190873624431802 48.00071302418453 28.60692141940177 47.652221407941326 28.691406 47.173828 L 29.751953 41.1875 C 30.920633 40.838997 32.033372 40.369697 33.082031 39.791016 L 38.070312 43.291016 C 38.4677984351913 43.569835678735394 39.00812284248828 43.522886811913494 39.351562 43.179688 L 43.240234 39.287109 C 43.58635884253118 38.940243201970105 43.63018334371835 38.39367949780705 43.34375 37.996094 L 39.787109 33.058594 C 40.355783 32.014958 40.813915 30.908875 41.154297 29.748047 L 47.171875 28.693359 C 47.650268407941326 28.60887441940177 47.99876002418453 28.192826624431802 47.998047 27.707031 L 47.998047 22.207031 C 47.997787676411804 21.717497522999718 47.643207687402 21.300101738345074 47.160156 21.220703 L 41.152344 20.238281 C 40.80968 19.078827 40.350281 17.974723 39.78125 16.931641 L 43.289062 11.933594 C 43.5678816787354 11.536107564808699 43.5209328119135 10.995783157511722 43.177734 10.652344 L 39.287109 6.7636719 C 38.940243125035 6.417547151422113 38.39367942651908 6.3737227776956535 37.996094 6.6601562 L 33.072266 10.201172 C 32.023186 9.6248101 30.909713 9.1579916 29.738281 8.8125 L 28.691406 2.828125 C 28.607763399254416 2.348955125660183 28.191493001530553 1.9994528068422304 27.705078 2 L 22.205078 2 z M 23.056641 4 L 26.865234 4 L 27.861328 9.6855469 C 27.929044914660185 10.075133850801762 28.21995139988209 10.388240873372174 28.603516 10.484375 C 30.066026 10.848832 31.439607 11.426549 32.693359 12.185547 C 33.03600756919579 12.393158782856133 33.46948671765437 12.37624993104274 33.794922 12.142578 L 38.474609 8.7792969 L 41.167969 11.472656 L 37.835938 16.220703 C 37.60857212753903 16.544304584556595 37.593260347032825 16.971497890600585 37.796875 17.310547 C 38.548366 18.561471 39.118333 19.926379 39.482422 21.380859 C 39.579324746181165 21.768029009610615 39.897147002706895 22.06051766497204 40.291016 22.125 L 45.998047 23.058594 L 45.998047 26.867188 L 40.279297 27.871094 C 39.889395381724604 27.940112287248493 39.57692744653398 28.232668148127694 39.482422 28.617188 C 39.122545 30.069817 38.552234 31.434687 37.800781 32.685547 C 37.594606932099026 33.028110531180594 37.6122733133994 33.460551470482464 37.845703 33.785156 L 41.224609 38.474609 L 38.53125 41.169922 L 33.791016 37.84375 C 33.46574854327684 37.615915089932976 33.03649336063164 37.60211770003485 32.697266 37.808594 C 31.44975 38.567585 30.074755 39.148028 28.617188 39.517578 C 28.23551064884404 39.613793579709224 27.94576612243851 39.92494382040216 27.876953 40.3125 L 26.867188 46 L 23.052734 46 L 22.111328 40.337891 C 22.04583842755697 39.94423717216324 21.752592915243802 39.62719420800885 21.365234 39.53125 C 19.90185 39.170557 18.522094 38.59371 17.259766 37.835938 C 16.921191318478126 37.63317307152783 16.49503551308596 37.64847469464101 16.171875 37.875 L 11.46875 41.169922 L 8.7734375 38.470703 L 12.097656 33.824219 C 12.329865105179428 33.498821176556525 12.345994571475426 33.06640157362733 12.138672 32.724609 C 11.372652 31.458855 10.793319 30.079213 10.427734 28.609375 C 10.332183343148055 28.226938415501134 10.020898397848066 27.936303881528456 9.6328125 27.867188 L 4.0019531 26.867188 L 4.0019531 23.052734 L 9.6289062 22.117188 C 10.022025538962975 22.05199479868345 10.33892953298193 21.759645025385023 10.435547 21.373047 C 10.804273 19.898143 11.383325 18.518729 12.146484 17.255859 C 12.35210645597429 16.91710242149066 12.338317911104822 16.48888840616317 12.111328 16.164062 L 8.8261719 11.46875 L 11.523438 8.7734375 L 16.185547 12.105469 C 16.50967768193481 12.336588834455698 16.940015422136796 12.353464924380376 17.28125 12.148438 C 18.536908 11.394293 19.919867 10.822081 21.384766 10.462891 C 21.77403145871616 10.367055127312424 22.068453629887163 10.04803321360581 22.132812 9.6523438 L 23.056641 4 z M 25 17 C 20.593567 17 17 20.593567 17 25 C 17 29.406433 20.593567 33 25 33 C 29.406433 33 33 29.406433 33 25 C 33 20.593567 29.406433 17 25 17 z M 25 19 C 28.325553 19 31 21.674447 31 25 C 31 28.325553 28.325553 31 25 31 C 21.674447 31 19 28.325553 19 25 C 19 21.674447 21.674447 19 25 19 z" stroke-linecap="round" />
                                </g>
                            </svg>
                            
                            <!-- Tooltip Popup -->
                            <div id="settings-tooltip" class="h-7 w-42 absolute bottom-full right-8 top-0 mb-2 px-3 py-1 bg-slate-100 text-sm rounded-lg border whitespace-nowrap pointer-events-none transition-all duration-300">
                                <span>View/edit settings ‚ûú</span>
                            </div>
                        </span>


                        <!-- Room Code Header -->
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="font-semibold text-slate-900">Room Code</h2>
                            {% if current_round %}
                            <span class="badge badge-info px-2 rounded-xl">Round {{ current_round.round_number }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center justify-center gap-4 py-3">
                            <span id="room-code" class="text-4xl font-mono font-bold text-slate-900 tracking-widest">{{ room.code }}</span>
                            <button 
                                onclick="copyRoomCode()"
                                class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors"
                                title="Copy room code"
                            >
                                <svg id="copy-icon" class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <svg id="check-icon" class="w-5 h-5 text-emerald-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Share Options -->
                        <div class="flex flex-wrap gap-3 justify-center mt-4 pt-3 border-t border-slate-100">
                            <button onclick="copyShareLink()" class="btn-secondary flex items-center justify-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                </svg>
                                <span id="copy-link-text">Copy Link</span>
                            </button>
                            <button onclick="showQRCode()" class="btn-secondary flex items-center gap-1.5 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                QR Code
                            </button>
                        </div>
                    </div>
                    
                    <!-- Players Card -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold text-slate-900">Players</h2>
                            <span id="player-count" class="text-sm text-slate-400">{{ round_players|length }}/{{ room.settings_max_players }}</span>
                        </div>
                        
                        <div id="players-list" class="space-y-2">
                            {% for player in round_players %}
                            <div class="player-card rounded-xl relative
                                {% if player.room_member.id == current_member.id %}bg-accent-50 border border-accent-100{% else %}bg-slate-50{% endif %}
                                {% if player.connection_status == 'disconnected' %} border border-dashed border-red-500{% endif %}" 
                                data-member-id="{{ player.room_member.id }} ">
                                <div class="flex items-center justify-between p-3">
                                    <div id="player-b-info-{{ player.room_member.id }}" class="flex items-center gap-3  {% if player.connection_status == 'disconnected' %}disconnected {% endif %}">
                                        
                                        <!--Disconnect Timer-->
                                        <div id="disconnect-timer-{{ player.room_member.id }}" class="w-7 h-7 rounded-full bg-red-100 text-red-700 flex items-center justify-center border-2 border-red-200 absolute -top-2 -left-2 {% if player.connection_status != 'disconnected' %} hidden {% endif %}" title="Player disconnected Timer">
                                            <!-- Countdown Number -->
                                            <span class="timer-value text-xs font-bold ">00</span>
                                        </div>

                                        <!-- Profile icon -->
                                        <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center">
                                            {% if player.is_host %}
                                                <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                </svg>
                                            {% else %}
                                                <span class="text-sm font-medium text-slate-500">{{ player.display_name|slice:": 1"|upper }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Player Info -->
                                        <div>
                                            <p class="font-medium text-slate-900 text-sm flex items-center gap-1">
                                                {{ player.display_name }} 
                                                {% if player.room_member.id == current_member.id %}<span class="text-slate-400 font-normal">(You)</span>{% endif %}
                                                <!--Disconnect Icon-->
                                                <span id="disconnected-icon-{{ player.room_member.id }}" class="p-1 rounded-full bg-red-100 {% if player.connection_status != 'disconnected' %} hidden {% endif %} " title="Player disconnected">
                                                    <svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' class="w-5 h-5 text-red-700" >
                                                        <g transform="matrix(0.69 0 0 0.69 12 12)" >
                                                            <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-17.59, -19.25)" d="M 16 6.5 C 10.984 6.5 6.4407812 8.565625 3.1757812 11.890625 L 4.5898438 13.304688 C 7.4918437 10.343687 11.535 8.5 16 8.5 C 20.465 8.5 24.508156 10.343687 27.410156 13.304688 L 28.824219 11.890625 C 25.559219 8.565625 21.016 6.5 16 6.5 z M 16 11.5 C 12.359 11.5 9.0699375 13.007781 6.7109375 15.425781 L 8.1210938 16.839844 C 10.121094 14.780844 12.914 13.5 16 13.5 C 17.682 13.5 19.272219 13.892266 20.699219 14.572266 C 21.628219 14.246266 22.617437 14.053578 23.648438 14.017578 C 21.501437 12.442578 18.864 11.5 16 11.5 z M 24 16 C 19.6 16 16 19.6 16 24 C 16 28.4 19.6 32 24 32 C 28.4 32 32 28.4 32 24 C 32 19.6 28.4 16 24 16 z M 16 16.5 C 13.738 16.5 11.699187 17.444938 10.242188 18.960938 L 11.65625 20.371094 C 12.67425 19.303094 14.078484 18.611531 15.646484 18.519531 C 16.109484 17.815531 16.662203 17.178281 17.283203 16.613281 C 16.864203 16.545281 16.438 16.5 16 16.5 z M 24 18 C 27.3 18 30 20.7 30 24 C 30 27.3 27.3 30 24 30 C 20.7 30 18 27.3 18 24 C 18 20.7 20.7 18 24 18 z M 21.699219 20.300781 L 20.300781 21.699219 L 22.599609 24 L 20.300781 26.300781 L 21.699219 27.699219 L 24 25.400391 L 26.300781 27.699219 L 27.699219 26.300781 L 25.400391 24 L 27.699219 21.699219 L 26.300781 20.300781 L 24 22.599609 L 21.699219 20.300781 z M 14.181641 22.132812 C 14.038641 22.243813 13.90225 22.362094 13.78125 22.496094 L 14.080078 22.794922 C 14.107078 22.571922 14.140641 22.350812 14.181641 22.132812 z" stroke-linecap="round" />
                                                        </g>
                                                    </svg>
                                                </span>
                                            </p>
                                            <p class="text-xs text-slate-400">
                                                {% if player.room_member.user %} @{{ player.room_member.user.username }}{% else %}Guest{% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <!-- Role Badge -->
                                        <div>
                                            {% if player.is_host  %}<span class="badge badge-warning px-1 rounded-md">Host</span>
                                            {% elif player.is_co_host  %}<span class="badge badge-success px-1 rounded-md">Co-Host</span>
                                            {%else%}<span class="badge badge-info px-1 rounded-md">Player</span>{% endif %}
                                        </div>
                                        
                                        {% if player.room_member.id != current_member.id %}
                                            {% if is_host or is_co_host %}
                                                <button onclick="kickPlayer({{ player.room_member.id }}, '{{ player.display_name }}')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Kick player">
                                                    <!-- Kick Icon -->
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"  class="w-4 h-4" >
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM4 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 10.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                                                    </svg>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Vote Bar Section (Hidden by default, shown when disconnected) -->
                                <div id="vote-bar-{{ player.room_member.id }}" 
                                    class="hidden border-t curs border-slate-200 bg-gradient-to-r from-slate-50 to-white rounded-b-xl ">
                                    
                                    <!-- Voting Timer Progress Bar -->
                                    <div class="relative h-1 bg-slate-200 overflow-hidden">
                                        <div id="vote-timer-bar-{{ player.room_member.id }}" 
                                            class="h-full bg-gradient-to-r from-amber-500 to-orange-500 transition-all duration-1000 ease-linear" 
                                            style="width: 100%;">
                                        </div>
                                    </div>
                                    
                                    <!-- Compact Vote Section -->
                                    <div class="flex items-center justify-between gap-2 px-3 py-1.5">

                                        <!-- Total Votes Indicator -->
                                        <div class="flex items-center gap-1 text-xs text-slate-500">
                                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                                            </svg>
                                            <span id="total-votes-{{ player.room_member.id }}" class="font-semibold">{{ player.votes_cast }} 0 / {{ player.total_voters }}0</span>
                                        </div>

                                        <!-- Vote Buttons -->
                                        <div class="flex items-center gap-1.5">
                                            <button id = "vote-keep-btn-{{ player.room_member.id }}" onclick="castVote({{ player.room_member.id }}, 'keep')"  title="Vote to Keep Player"
                                                    class="flex items-center gap-1 px-2 py-1 bg-green-50 hover:bg-green-100 text-green-700 rounded transition-colors text-xs font-medium">
                                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                                <span id="keep-count-{{ player.room_member.id }}" class="font-semibold">0</span>
                                            </button>
                                            
                                            <div class="h-4 w-px bg-slate-300"></div>
                                            
                                            <button id = "vote-kick-btn-{{ player.room_member.id }}" onclick="castVote({{ player.room_member.id }}, 'kick')" title="Vote to Kick Player"
                                                    class="flex items-center gap-1 px-2 py-1 bg-red-50 hover:bg-red-100 text-red-700 rounded transition-colors text-xs font-medium">
                                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                                <span id="kick-count-{{ player.room_member.id }}" class="font-semibold">0</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            
                            {% empty %}
                            <p class="text-slate-400 text-center py-4">No players yet</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                </div>
                
                <!-- Right Column: Actions & Settings -->
                <div class="space-y-6 ">
                    <!-- Actions -->
                    <div class="card p-6">
                        <h2 class="font-semibold text-slate-900 mb-4">Actions</h2>
                        
                        <div class="space-y-3">
                            {% if is_host or is_co_host %}
                            <button id="start-game-btn" onclick="startGame()" class="w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed" {% if round_players|length < 2 %}disabled{% endif %}>
                                Start Game
                            </button>
                            <p id="start-hint" class="text-xs text-slate-400 text-center">
                                {% if round_players|length < 2 %}Need at least 2 players{% else %}Click to start when ready{% endif %}
                            </p>
                            {% else %}
                            <div class="text-center text-slate-500 text-sm ">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                Waiting for host to start the game...
                            </div>
                            {% endif %}
                            
                            <button onclick="showLeaveModal()" class="w-full btn-secondary text-red-600 hover:bg-red-50 border-red-200">
                                Leave Room
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="is-host" value="{{ is_host|yesno:'1,0' }}">

                    <!-- Round History Card -->
                    {% if round_history %}
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-slate-900">Round History</h3>
                            <span class="text-xs text-slate-400">{{ round_history|length }} round{{ round_history|length|pluralize }}</span>
                        </div>
                        
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            {% for round in round_history %}
                            <div class="flex-row justify-between p-3 rounded-xl bg-slate-50">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full {% if round.winners %}bg-amber-100{% else %}bg-slate-200{% endif %} flex items-center justify-center">
                                       <span class= "text-xs font-medium text-amber-700 p-2">R{{ round.round_number }}</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400">
                                            {% if round.winners.exists %}
                                            üèÜ {% for winner in round.winners.all %}{{ winner.display_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                            {% else %}
                                            No winner
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-2 flex items-center justify-between">
                                    {% if round.finished_at %}
                                    <p class="text-xs text-slate-400">{{ round.finished_at|timesince }} ago</p>
                                    {% endif %}
                                    <p class="text-xs text-slate-500">{{ round.called_numbers|length }} calls</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                                        
                </div>
                
            </div>
            
        </div>
    </main>
    
</div>

<!-- Host Settings -->
{% if is_host or is_co_host %}
    <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50  hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[26rem] ">
            
            <!-- Header -->
            <div class="px-4 py-4 border-b relative">
                <div class="flex justify-between items-center">
                    <h2 class="font-semibold text-lg text-slate-800">Game Settings</h2>
                    <button id="reset-settings-btn" title="Reset to Default settings" onclick="resetSettings()" class="p-1 rounded-lg hover:bg-slate-100 text-slate-500 transition-colors hidden">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>

                    <button onclick="OpenCloseSettings()" class="absolute -top-2 -right-2 border border-red-700 p-1 rounded-full bg-rose-50 hover:bg-rose-100 text-rose-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="p-4 space-y-2 max-h-[60vh] relative overflow-auto">
                
                <!-- Setup Duration -->
                <div class="setting-card p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Setup Time</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Setup Time</strong><br>
                                        Time players have to arrange their bingo board before the game starts.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="setup-duration-display" class="text-base text-slate-800">{{ room.settings_setup_duration }}s</span>
                    </div>
                    <input type="range" id="setup-duration" min="15" max="120" value="{{ room.settings_setup_duration }}" class="w-full" oninput="updateDisplay('setup-duration')">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>15s</span>
                        <span>120s</span>
                    </div>
                </div>
                
                <!-- Turn Duration -->
                <div class="setting-card p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8  rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Turn Time</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Turn Time</strong><br>
                                        Time each player has to pick a number on their turn.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="turn-duration-display" class="text-base text-slate-800">{{ room.settings_turn_duration }}s</span>
                    </div>
                    <input type="range" id="turn-duration" min="10" max="60" value="{{ room.settings_turn_duration }}" class="w-full" oninput="updateDisplay('turn-duration')">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>10s</span>
                        <span>60s</span>
                    </div>
                </div>
                
                <!-- Max Players -->
                <div class="setting-card p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Max Players</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Max Players</strong><br>
                                        Maximum number of players allowed in this room.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="max-players-display" class="text-base text-slate-800">{{ room.settings_max_players }}</span>
                    </div>
                    <input type="range" id="max-players" min="2" max="15" value="{{ room.settings_max_players }}" class="w-full" oninput="updateDisplay('max-players')">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>2</span>
                        <span>15</span>
                    </div>
                </div>
                
                <!-- Grace Period -->
                <div class="setting-card p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Disconnect Grace</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Disconnect Grace Period</strong><br>
                                        Time to wait before taking action when a player disconnects.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="grace-period-display" class="text-base text-slate-800">{{ room.settings_grace_period }}s</span>
                    </div>
                    <input type="range" id="grace-period" min="5" max="60" value="{{ room.settings_grace_period }}" class="w-full" oninput="updateDisplay('grace-period')">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>5s</span>
                        <span>60s</span>
                    </div>
                </div>
                
                <!-- Show Score Toggle -->
                <div class="setting-card p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Show Scores</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Show Scores</strong><br>
                                        Players can see how many lines others have completed.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="show-score" class="sr-only peer" {% if room.settings_show_score %}checked{% endif %} onclick="updateDisplay('show-score')">
                            <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-sky-500 shadow-inner"></div>
                        </label>
                    </div>
                </div>
                
            </div>
            
            <!-- Footer Actions -->
            <div class="px-5 py-3 bg-slate-50 border-t border-slate-200 rounded-b-2xl">
                <div class="flex gap-2">
                    <button onclick="OpenCloseSettings()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                        Close
                    </button>
                    <button id="save-settings-btn" onclick="saveSettings()" class="flex-1 px-4 py-2 bg-gradient-to-br from-accent-500 to-accent-600 text-white rounded-lg text-sm font-medium hover:bg-accent-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Save
                    </button>
                </div>
            </div>
            
        </div>
    </div>
{%else%}
    <!-- Game settings (view only for non-hosts) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[26rem]">

            <!-- Header -->
            <div class="px-4 py-4 border-b relative">
                <div class="flex-col justify-between items-center">
                    <h2 class="font-semibold text-lg text-slate-800">Game Settings</h2>
                    <p class="text-red-500 text-[10px]">
                        Only Host and Co-Hosts can modify game settings. You can only view.
                    </p>
                </div>
                <button onclick="OpenCloseSettings()" class="absolute -top-2 -right-2 border border-red-700 p-1 rounded-full bg-rose-50 hover:bg-rose-100 text-rose-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Settings Content -->
            <div class="p-4 space-y-2 max-h-[60vh] relative overflow-auto">
                <!-- Setup Duration -->
                <div class= " p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8  rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Setup Time</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Setup Time</strong><br>
                                        Time players have to arrange their bingo board before the game starts.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="setup-duration-display" class="text-base text-slate-800">{{ room.settings_setup_duration }}s</span>
                    </div>
                    <input type="range" id="setup-duration" min="15" max="120" value="{{ room.settings_setup_duration }}" class="w-full" disabled>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>15s</span>
                        <span>120s</span>
                    </div>
                    
                </div>

                <!-- Turn Duration -->
                <div class=" p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Turn Time</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Turn Time</strong><br>
                                        Time each player has to pick a number on their turn.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="turn-duration-display" class="text-base text-slate-800">{{ room.settings_turn_duration }}s</span>
                    </div>
                    <input type="range" id="turn-duration" min="10" max="60" value="{{ room.settings_turn_duration }}" class="w-full" disabled>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>10s</span>
                        <span>60s</span>
                    </div>
                </div>
                
                <!-- Max Players -->
                <div class=" p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8  rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Max Players</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Max Players</strong><br>
                                        Maximum number of players allowed in this room.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="max-players-display" class="text-base text-slate-800">{{ room.settings_max_players }}</span>
                    </div>
                    <input type="range" id="max-players" min="2" max="15" value="{{ room.settings_max_players }}" class="w-full" disabled>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>2</span>
                        <span>15</span>
                    </div>
                </div>
                
                <!-- Grace Period -->
                <div class=" p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8  rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Disconnect Grace</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Disconnect Grace Period</strong><br>
                                        Time to wait before taking action when a player disconnects.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span id="grace-period-display" class="text-base text-slate-800">{{ room.settings_grace_period }}s</span>
                    </div>
                    <input type="range" id="grace-period" min="5" max="60" value="{{ room.settings_grace_period }}" class="w-full" disabled>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>5s</span>
                        <span>60s</span>
                    </div>
                </div>
                
                <!-- Show Score Toggle -->
                <div class=" p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <div class="w-8 h-8  rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700">Show Scores</label>
                                <div class="tooltip-container inline-block ml-1">
                                    <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="tooltip-content">
                                        <strong>Show Scores</strong><br>
                                        Players can see how many lines others have completed.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="show-score" class="sr-only peer" {% if room.settings_show_score %}checked{% endif %} disabled>
                            <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-sky-500 shadow-inner"></div>
                        </label>
                    </div>
                </div>
                
            </div>

                
            <!-- Footer Actions -->
            <div class="px-5 py-3 bg-slate-50 border-t border-slate-200 rounded-b-2xl">
                <div class="flex gap-2">
                    <button onclick="OpenCloseSettings()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endif %}


<!-- QR Code Modal -->
<div id="qr-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeModal('qr-modal', event)">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
        <h3 class="text-lg font-bold text-center mb-4">Scan to Join</h3>
        <div id="qr-code" class="flex justify-center mb-4"></div>
        <p class="text-sm text-slate-500 mb-4 text-center">Room:  {{ room.code }}</p>
        <button onclick="hideQRCode('qr-modal')" class="w-full btn-secondary inline-block">Close</button>
    </div>
</div>

<!-- Kick Confirm Modal -->
<div id="kick-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-sm mx-4">
        <h3 class="font-semibold text-slate-900 mb-2">Remove Player</h3>
        <p class="text-slate-500 mb-6">Remove <span id="kick-player-name" class="font-medium"></span> from the room?</p>
        <p class="text-xs text-red-500 mb-4">On 3rd kick player gets banned.</p>
        <div class="flex gap-3">
            <button onclick="hideKickModal()" class="btn-secondary flex-1">Cancel</button>
            <button onclick="confirmKick()" class="btn-primary flex-1 bg-red-500 hover:bg-red-600">Kick üëü</button>
        </div>
    </div>
</div>

<!-- Leave Room Modal -->
<div id="leave-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeModal('leave-modal', event)">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900">Leave Room</h3>
            <p class="text-slate-600 mt-2">Are you sure you want to leave this room?</p>
            {% if current_member.is_host %}
            <p class="text-amber-600 text-sm mt-2">As host, leadership will transfer to another player.</p>
            {% endif %}
        </div>
        <div class="flex gap-3">
            <button onclick="closeModal('leave-modal')" class="flex-1 btn-secondary">Stay</button>
            <button onclick="confirmLeave()" class="flex-1 btn-primary bg-red-500 hover:bg-red-600">Leave</button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const roomCode = "{{ room.code }}";
    const currentMemberId = {{ current_member.id }};
    const isHost = {{ is_host|yesno:"true,false" }};
    const shareUrl = "{{ share_url }}";
    
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let kickTargetId = null;

    let disconnectedUserStatus = new Map();
    let pendingDisconnectNotifications = {};
    let isInitialLobbyLoad = sessionStorage.getItem('isInitialLobby') === 'true';
    console.log("Is Initial Lobby Load:", isInitialLobbyLoad);

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEBSOCKET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/room/${roomCode}/`;
        let shouldReconnect = true;
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            updateConnectionStatus('connected');
        };
        
        socket.onclose = function() {
            console.log('WebSocket disconnected');
            updateConnectionStatus('disconnected');
            if (!shouldReconnect) return;
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 2000);
            }
        };
        
        socket.onerror = function(e) {
            console.error('WebSocket error:', e);
            updateConnectionStatus('error');
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received:', data);
            if (data.type === 'connection_error') {
                    shouldReconnect = false;
                    showNotification(data.reason + " Plz Click to join again in 2 seconds", 'error');
                    setTimeout(() => window.location.href = `/join/${roomCode}/`, 1500);
                    socket.close();
                    return;
                }
            handleMessage(data);
        };
    }
    
    function sendMessage(type, payload = {}) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type, ...payload }));
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MESSAGE HANDLERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function handleMessage(data) {
        switch (data.type) {
            case 'player_connected':
                clearDisconnectTimer(data.member_id, remove_ = true);
                updatePlayersList(data.round_players);
                console.log("Initial Lobby Load Status: 3", isInitialLobbyLoad);

                if (!isInitialLobbyLoad) {
                    isInitialLobbyLoad = true;
                    sessionStorage.setItem('isInitialLobby', 'true');
                    return;
                }


                if (pendingDisconnectNotifications[data.member_id]) {
                    clearTimeout(pendingDisconnectNotifications[data.member_id]);
                    delete pendingDisconnectNotifications[data.member_id];
                    return;
                }

                if (data.member_id !== currentMemberId) {
                    if (data.is_reconnection) {
                        clearDisconnectTimer(data.member_id);
                        showNotification(`${data.member_name} Reconnected to the room`, 'info');
                    }
                    else{
                        showNotification(`${data.member_name} joined`, 'success_light');
                    }
                } 
                break;
            case 'player_disconnected':
                handlePlayerDisconnected(data);

                const timeoutId = setTimeout(() => {
                    showNotification(`${data.member_name} disconnected`, 'warning_light', 'bottom');
                    delete pendingDisconnectNotifications[data.member_id];
                }, 1500);
                pendingDisconnectNotifications[data.member_id] = timeoutId;

                break;

            case 'player_timerestarted':
                handlePlayerDisconnected(data);
                break;

            case 'player_left':
                updatePlayersList(data.round_players);
                if (data.was_host) {
                    if (data.new_cohost_id === currentMemberId) {
                        showNotification(`You are now a Co-Host. ${data.member_name} Left Room.`, 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                }else{
                    showNotification(`${data.new_cohost_name} is now a Co-Host. ${data.member_name} Left Room.`, 'info');
                }
                break;
            
            case 'player_kicked':
                if (data.kicked_member_id === currentMemberId) {
                    showNotification('You are being removed from the room', 'error');
                    setTimeout(() => window.location.href = '/', 1000);
                } else {
                    updatePlayersList(data.round_players);
                    showNotification(`${data.kicked_name} was removed`, 'info');
                }
                break;

            case 'vote_kick_started':
                handleVoteKickStarted(data);
                break;

            case 'vote_updated':
                handleVoteUpdated(data);
                break;

            case 'player_voted_ended':
                updatePlayersList(data.round_players);
                if (data.kicked_member_id === currentMemberId) {
                    showNotification('You have been removed from the room', 'error');
                    setTimeout(() => window.location.href = '/', 1000);
                }
                else{
                    showNotification(`${data.kicked_name} is Removed.`, 'info');
                    if (data.new_cohost_id){
                        if (data.new_cohost_id === currentMemberId) {
                        showNotification('You are now a Co-Host.', 'success');
                        setTimeout(() => location.reload(), 1500);
                        }
                        else{
                            showNotification(`${data.new_cohost_name} is now a Co-Host.`, 'info');
                        }
                    }
                }
                break;

            case 'game_starting':
                showNotification(data.message, 'success');
                setTimeout(() => window.location.href = `/room/${roomCode}/game/`, 1000);
                break;
            case 'settings_updated':
                settingsUpdate(data.settings);
                showNotification(`Settings updated by ${data.updated_by}`, 'info');
                break;
            case 'new_round_created':
                showNotification(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
                break;
            case 'leave_confirmed':
                window.location.href = data.redirect_url;
                break;            
            
            case 'error':
                showNotification(data.message, 'error');
                break;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MESSAGE HANDLERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function handlePlayerDisconnected(data) {
        
        // Start countdown display
        startDisconnectTimer(data.member_id, data.member_name, data.deadline, data.grace_period);
        
        const playercard = document.querySelector(`[data-member-id="${data.member_id}"]`);
        if (playercard) playercard.classList.add('border', 'border-dashed', 'border-red-500');

        disconnectedIcon = document.getElementById(`disconnected-icon-${data.member_id}`);
        if (disconnectedIcon) {
            disconnectedIcon.classList.remove('hidden');
        }

        playerBInfo = document.getElementById(`player-b-info-${data.member_id}`);
        if (playerBInfo) {
            playerBInfo.classList.add('disconnected');
        }
    }



    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DISCONNECT TIMER UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function startDisconnectTimer(memberId, memberName, deadline, gracePeriod) {

        disconnectedTimer = document.getElementById(`disconnected-timer-${memberId}`);
        if (disconnectedTimer) {
            disconnectedTimer.classList.remove('hidden');
        }
        
        const deadlineTime = new Date(deadline).getTime();
        starting_color = ['bg-amber-100', 'text-amber-700'];
        ending_color = ['bg-red-100', 'text-red-700'];
        // selecting countdown element
        const timer_container = document.getElementById(`disconnected-timer-${memberId}`);
        const timer_value = timer_container.querySelector('.timer-value');

        timer_value.textContent = gracePeriod;

        timer_value.classList.remove(...ending_color);
        timer_value.classList.add(...starting_color);

        const update = () => {
            const remaining = Math.max(0, Math.ceil((deadlineTime - Date.now()) / 1000));
            timer_value.textContent = remaining;
            
            if (remaining <= 5) {
                timer_value.classList.remove(...starting_color);
                timer_value.classList.add(...ending_color);
            }
            
            if (remaining <= 0) clearDisconnectTimer(memberId);
        };
        
        update();
        const timer = setInterval(update, 1000);
        disconnectedUserStatus.set(memberId, { timer, status: 'timer' });
    }


    function clearDisconnectTimer(memberId, remove_ = false) {
        const data = disconnectedUserStatus.get(memberId);
        if (data) {
            clearInterval(data.timer);
            if (remove_) {
                disconnectedUserStatus.delete(memberId);
            }else{
                disconnectedUserStatus.set(memberId, { status: 'vote' });
            }
        }
        disconnectedTimer = document.getElementById(`disconnected-timer-${memberId}`);
        if (disconnectedTimer) {
            disconnectedTimer.classList.add('hidden');
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VOTE KICK HANDLERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function handleVoteKickStarted(data) {
        const { target_member_id, target_member_name, total_voters, total_time } = data;
        showNotification(`Vote to Kick or Keep ${target_member_name}, in ${total_time} seconds`, 'warning_light');

        if (target_member_id === currentMemberId) return;
        
        vote_bar = document.getElementById(`vote-bar-${target_member_id}`);
        vote_bar.classList.remove('hidden');
        vote_count = document.getElementById(`votes-count-${target_member_id}`);
        vote_count.textContent = `0/${total_voters} votes`;

        const timerBar = document.getElementById(`vote-timer-bar-${target_member_id}`);
        let time_left = total_time;


        const interval = setInterval(() => {
            time_left -= 1;
            if (time_left >= 0) {
                updateVoteTimerBar(target_member_id, time_left, total_time,timerBar);
            } else {
                clearInterval(interval);
            }
        }, 1000);
    }


    function updateVoteTimerBar(target_member_id, time_left, total_time,timerBar) {
        if (!timerBar) return;
        const percentage = (time_left / total_time) * 100;
        timerBar.style.width = `${percentage}%`;


        // Change color based on urgency
        if (time_left <= 5) {
            timerBar.className = 'h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-1000 ease-linear';
        } else if (time_left <= 10) {
            timerBar.className = 'h-full bg-gradient-to-r from-orange-500 to-red-500 transition-all duration-1000 ease-linear';
        } else {
            timerBar.className = 'h-full bg-gradient-to-r from-amber-500 to-orange-500 transition-all duration-1000 ease-linear';
            }
    }

    function handleVoteUpdated(data) {
        const { target_member_id, votes,target_name , total_voters, total_voted } = data;
        
        if (target_member_id === currentMemberId) return;
        
        vote_count = document.getElementById(`votes-count-${target_member_id}`);
        vote_count.textContent = `${total_voted}/${total_voters} votes`;
        document.getElementById(`kick-count-${target_member_id}`).textContent = votes['kick'];
        document.getElementById(`keep-count-${target_member_id}`).textContent = votes['keep'];

        // If voting complete
        if (votes['kick'] + votes['keep'] == total_voters) {
            updateData = false
            if (total_voted == 0){
                showNotification(`No votes casted for ${target_name}. Grace time Extend`, 'info');
                updateData = true
            }
            else if (votes['kick'] > votes['keep']) {
                // Result is to kick
                // showNotification(`Voted Kick, for ${target_name}. Player Removed`, 'error');
            } else if (votes['keep'] > votes['kick']) {
                // Result is to keep
                showNotification(`Voted Extend, For${target_name}. Grace time Extend`, 'info');
                updateData = true

            }else if (votes['keep'] === votes['kick']){
                // Result is tie
                showNotification(`Voted tie, for ${target_name}. Grace time Extend`, 'info');
                updateData = false
            }

            disconnectedUserStatus.delete(target_member_id);



            // hide vote bar
            const vote_bar = document.getElementById(`vote-bar-${target_member_id}`);
            vote_bar.classList.add('hidden');

            if (updateData){
                // Enable the vote buttons again
                document.getElementById(`kick-count-${target_member_id}`).textContent = 0;
                document.getElementById(`keep-count-${target_member_id}`).textContent = 0;


                kickBTN = document.getElementById(`vote-kick-btn-${target_member_id}`);
                keepBTN = document.getElementById(`vote-keep-btn-${target_member_id}`);

                kickBTN.disabled = false;
                keepBTN.disabled = false;

                kickBTN.classList.remove('cursor-not-allowed');
                keepBTN.classList.remove('cursor-not-allowed');
                
                kickBTN.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                keepBTN.classList.remove('bg-green-500', 'text-white','hover:bg-green-600');
            }



        }
    }

    function castVote(targetMemberId, vote) {
        data = disconnectedUserStatus.get(targetMemberId);

        if (data && data.status === 'vote') {
            votedby = data.votedby || [];
            if (votedby.includes(currentMemberId)) {
                showNotification('You have already voted for this player.', 'error');
                return;
            }
            votedby.push(currentMemberId);
            disconnectedUserStatus.set(targetMemberId, { status: 'vote', votedby: votedby });

            // disable vote buttons
            kickBTN = document.getElementById(`vote-kick-btn-${targetMemberId}`);
            keepBTN = document.getElementById(`vote-keep-btn-${targetMemberId}`);

            kickBTN.disabled = true;
            keepBTN.disabled = true;

            kickBTN.classList.add('cursor-not-allowed');
            keepBTN.classList.add('cursor-not-allowed');

            if (vote === 'kick') {
                kickBTN.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
            } else {
                keepBTN.classList.add('bg-green-500', 'text-white','hover:bg-green-600');
            }

            // send vote to server
            sendMessage('cast_vote', {target_member_id: targetMemberId, vote: vote });

        } else{
            showNotification('Voting period has ended or not started yet.', 'error');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI UPDATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function updateConnectionStatus(status) {
        const el = document.getElementById('connection-status');
        el.className = 'badge';
        if (status === 'connected') {
            el.classList.add('badge-success');
            el.textContent = 'Connected';
        } else if (status === 'disconnected') {
            el.classList.add('badge-warning');
            el.textContent = 'Reconnecting...';
        } else {
            el.classList.add('badge-warning');
            el.textContent = 'Error';
        }
    }
    
    function updatePlayersList(players) {
        const container = document.getElementById('players-list');
        const countEl = document.getElementById('player-count');
        const startBtn = document.getElementById('start-game-btn');
        const startHint = document.getElementById('start-hint');
        
        if (countEl) {
            countEl.textContent = `${players.length}/${document.getElementById('max-players')?.value || 6}`;
        }
        
        if (startBtn && isHost) {
            startBtn.disabled = players.length < 2;
            if (startHint) {
                startHint.textContent = players.length < 2 ? 'Need at least 2 players' : 'Click to start when ready';
            }
        }
        
        const crownSvg = `<svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
        
        container.innerHTML = players.map(player => {
            const isMe = player.member_id === currentMemberId;
            const roleText = player.role === 'host' ?  'Host' : player.role === 'co-host' ? 'Co-Host' : 'Player';
            
            return `
                <div class="player-card rounded-xl relative
                ${isMe ? 'bg-accent-50 border border-accent-100' : 'bg-slate-50'} 
                ${player.connection_status === 'disconnected' ? 'border border-dashed border-red-500' : ''}" 
                data-member-id="${player.member_id}">
                    <div class="flex items-center justify-between p-3">
                        <div id="player-b-info-${player.member_id}" class="flex items-center gap-3 ${player.connection_status === 'disconnected' ? 'disconnected' : ''}">
                            
                            
                            <!--Disconnect Timer-->
                            <div id="disconnected-timer-${player.member_id}" class="w-7 h-7 rounded-full bg-red-100 text-red-700 flex items-center justify-center border-2 border-red-200 absolute -top-2 -left-2 ${ player.connection_status !== 'disconnected' ? 'hidden' : '' }" title="Player disconnected Timer">
                                <!-- Countdown Number -->
                                <span class="timer-value text-xs font-bold"></span>
                            </div>


                            <!-- Profile icon -->
                            <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center">
                                ${player.is_host ? crownSvg : `<span class="text-sm font-medium text-slate-500">${player.name.charAt(0).toUpperCase()}</span>`}
                            </div>

                            <!-- Player Info -->
                            <div>
                                <p class="font-medium text-slate-900 text-sm flex items-center gap-1">
                                    ${player.name}${isMe ? '<span class="text-slate-400 font-normal"> (You)</span>' : ''}
                                    
                                    <!--Disconnect Icon-->
                                    <span id="disconnected-icon-${player.member_id}" class="p-1 rounded-full bg-red-100 ${ player.connection_status !== 'disconnected' ? 'hidden' : '' }" title="Player disconnected">
                                        <svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' class="w-5 h-5 text-red-700" >
                                            <g transform="matrix(0.69 0 0 0.69 12 12)" >
                                                <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-17.59, -19.25)" d="M 16 6.5 C 10.984 6.5 6.4407812 8.565625 3.1757812 11.890625 L 4.5898438 13.304688 C 7.4918437 10.343687 11.535 8.5 16 8.5 C 20.465 8.5 24.508156 10.343687 27.410156 13.304688 L 28.824219 11.890625 C 25.559219 8.565625 21.016 6.5 16 6.5 z M 16 11.5 C 12.359 11.5 9.0699375 13.007781 6.7109375 15.425781 L 8.1210938 16.839844 C 10.121094 14.780844 12.914 13.5 16 13.5 C 17.682 13.5 19.272219 13.892266 20.699219 14.572266 C 21.628219 14.246266 22.617437 14.053578 23.648438 14.017578 C 21.501437 12.442578 18.864 11.5 16 11.5 z M 24 16 C 19.6 16 16 19.6 16 24 C 16 28.4 19.6 32 24 32 C 28.4 32 32 28.4 32 24 C 32 19.6 28.4 16 24 16 z M 16 16.5 C 13.738 16.5 11.699187 17.444938 10.242188 18.960938 L 11.65625 20.371094 C 12.67425 19.303094 14.078484 18.611531 15.646484 18.519531 C 16.109484 17.815531 16.662203 17.178281 17.283203 16.613281 C 16.864203 16.545281 16.438 16.5 16 16.5 z M 24 18 C 27.3 18 30 20.7 30 24 C 30 27.3 27.3 30 24 30 C 20.7 30 18 27.3 18 24 C 18 20.7 20.7 18 24 18 z M 21.699219 20.300781 L 20.300781 21.699219 L 22.599609 24 L 20.300781 26.300781 L 21.699219 27.699219 L 24 25.400391 L 26.300781 27.699219 L 27.699219 26.300781 L 25.400391 24 L 27.699219 21.699219 L 26.300781 20.300781 L 24 22.599609 L 21.699219 20.300781 z M 14.181641 22.132812 C 14.038641 22.243813 13.90225 22.362094 13.78125 22.496094 L 14.080078 22.794922 C 14.107078 22.571922 14.140641 22.350812 14.181641 22.132812 z" stroke-linecap="round" />
                                            </g>
                                        </svg>
                                    </span>
                                </p>
                                <p class="text-xs text-slate-400">${ player.user ? `@${player.user.username}` : 'Guest Player'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <!-- Role Badge -->
                            <div>
                                ${player.is_host 
                                    ? '<span class="badge badge-warning px-1 rounded-md">Host</span>' 
                                    : player.role === 'co-host'
                                        ? '<span class="badge badge-success px-1 rounded-md">Co-Host</span>'
                                        : '<span class="badge badge-info px-1 rounded-md">Player</span>'
                                }
                            </div>
                            ${isHost && ! isMe ? `
                                <button onclick="kickPlayer(${player.member_id}, '${player.name}')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Kick player">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"  class="w-4 h-4" >
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM4 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 10.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Vote Bar Section (Hidden by default, shown when disconnected) -->
                    <div id="vote-bar-${player.member_id}"
                        class="hidden border-t border-slate-200 bg-gradient-to-r from-slate-50 to-white rounded-b-xl ">
                        
                        <!-- Voting Timer Progress Bar -->
                        <div class="relative h-1 bg-slate-200 overflow-hidden">
                            <div id="vote-timer-bar-${player.member_id}" 
                                class="h-full bg-gradient-to-r from-amber-500 to-orange-500 transition-all duration-1000 ease-linear" 
                                style="width: 100%;">
                            </div>
                        </div>
                        
                        <!-- Compact Vote Section -->
                        <div class="flex items-center justify-between gap-2 px-3 py-1.5">
                            <!-- Total Votes Indicator -->
                            <div class="flex items-center gap-1 text-xs text-slate-500">
                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                                </svg>
                                <span id="votes-count-${player.member_id}" class="font-semibold">0/0</span>
                            </div>

                            <!-- Vote Buttons -->
                            <div class="flex items-center gap-1.5">
                                <button id="vote-keep-btn-${player.member_id}" onclick="castVote(${player.member_id}, 'keep')"  title="Vote to Keep Player"
                                        class="flex items-center gap-1 px-2 py-1 bg-green-50 hover:bg-green-100 text-green-700 rounded transition-colors text-xs font-medium">
                                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span id="keep-count-${player.member_id}" class="font-semibold">0</span>
                                </button>
                                
                                <div class="h-4 w-px bg-slate-300"></div>
                                
                                <button id="vote-kick-btn-${player.member_id}" onclick="castVote(${player.member_id}, 'kick')" title="Vote to Kick Player"
                                        class="flex items-center gap-1 px-2 py-1 bg-red-50 hover:bg-red-100 text-red-700 rounded transition-colors text-xs font-medium">
                                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span id="kick-count-${player.member_id}" class="font-semibold">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



    function startGame() {
        sendMessage('start_game');
    }

    function resetSettings() {
        document.getElementById('setup-duration').value = 60;
        document.getElementById('turn-duration').value = 20;
        document.getElementById('max-players').value = 8;
        document.getElementById('grace-period').value = 15;
        document.getElementById('show-score').checked = false;
        
        updateDisplay('setup-duration');
        updateDisplay('turn-duration');
        updateDisplay('max-players');
        updateDisplay('grace-period');
        showNotification('Settings reset to default', 'success_light');
        
        document.getElementById('reset-settings-btn').classList.add('hidden');
        setting_btn = document.getElementById('save-settings-btn')
        setting_btn.disabled = true;
    }

    function updateDisplay(settingId, btn_change = true) {
        if (settingId != 'show-score') {
            const input = document.getElementById(settingId);
            const display = document.getElementById(`${settingId}-display`);
            display.textContent = `${input.value}${settingId.includes('duration') || settingId === 'grace-period' ? 's' : ''}`;
        } else {
            const checkbox = document.getElementById('show-score');
            checkbox.value = checkbox.checked ? 'true' : 'false';
        }
        
        if (btn_change) {
            setting_btn = document.getElementById('save-settings-btn')
            setting_btn.disabled = false;
            document.getElementById('reset-settings-btn').classList.remove('hidden');
        }

    }
    
    function saveSettings() {
        const settings = {
            setup_duration:  parseInt(document.getElementById('setup-duration').value),
            turn_duration: parseInt(document.getElementById('turn-duration').value),
            max_players: parseInt(document.getElementById('max-players').value),
            grace_period: parseInt(document.getElementById('grace-period').value),
            show_score: document.getElementById('show-score').value === 'true'
        };
        setting_btn = document.getElementById('save-settings-btn')
        setting_btn.disabled = true;

        document.getElementById('reset-settings-btn').classList.add('hidden');

        sendMessage('update_settings', { settings });
        showNotification('Settings saved', 'success');
        OpenCloseSettings();
    }

    function settingsUpdate(data){
        is_host = document.getElementById('is-host').value === 'true';
        if (! is_host){
            document.getElementById('setup-duration').value = data.setup_duration;
            document.getElementById('turn-duration').value = data.turn_duration;
            document.getElementById('max-players').value = data.max_players;
            document.getElementById('grace-period').value = data.grace_period;
            document.getElementById('show-score').checked = data.show_score;

            updateDisplay('setup-duration', false);
            updateDisplay('turn-duration', false);
            updateDisplay('max-players', false);
            updateDisplay('grace-period', false);
        }
    }

    function OpenCloseSettings() {
        setting_modal = document.getElementById('settings-modal');
        setting_modal.classList.toggle('hidden');
    }
    
    function copyRoomCode() {
        navigator.clipboard.writeText(roomCode).then(() => {
            document.getElementById('copy-icon').classList.add('hidden');
            document.getElementById('check-icon').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('copy-icon').classList.remove('hidden');
                document.getElementById('check-icon').classList.add('hidden');
            }, 2000);
        });
        showNotification('Room code copied! ', 'success_light');
    }
    
    function copyShareLink() {
        const fullUrl = shareUrl;
        navigator.clipboard.writeText(fullUrl).then(() => {
            document.getElementById('copy-link-text').textContent = 'Copied!';
            setTimeout(() => document.getElementById('copy-link-text').textContent = 'Copy Link', 2000);
        });
        showNotification('Share link copied! ', 'success_light');
    }
    
    function showQRCode() {
        const modal = document.getElementById('qr-modal');
        const qrContainer = document.getElementById('qr-code');
        qrContainer.innerHTML = '';

        const fullUrl =  shareUrl;

        QRCode.toCanvas(fullUrl, { width: 200 }, (err, canvas) => {
            if (! err) qrContainer.appendChild(canvas);
        });


        modal.classList.remove('hidden');
    }
    
    function hideQRCode() {
        document.getElementById('qr-modal').classList.add('hidden');
    }
    
    function kickPlayer(memberId, name) {
        kickTargetId = memberId;
        document.getElementById('kick-player-name').textContent = name;
        document.getElementById('kick-modal').classList.remove('hidden');
    }
    
    function hideKickModal() {
        document.getElementById('kick-modal').classList.add('hidden');
        kickTargetId = null;
    }
    
    function confirmKick() {
        if (kickTargetId) {
            sendMessage('kick_player', { member_id: kickTargetId });
        }
        hideKickModal();
    }
    
        
    function showModal(id) {
        document.getElementById(id).classList.remove('hidden');
    }
    
    function closeModal(id, event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById(id).classList.add('hidden');
    }

    function showLeaveModal(id) {
        showModal('leave-modal');
    }
    
    function confirmLeave() {
        sendMessage('leave_room');
    }

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTIFICATIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showNotification(message, type = 'info', position='top', title=null, timeout=4000, argss={}) {

        const container = document.getElementById('notification-container-' + position);
        
        const colors = {
            success: 'bg-emerald-500 text-white',
            success_light: 'bg-emerald-100 text-emerald-900',
            error:  'bg-red-500 text-white',
            error_light: 'bg-red-100 text-red-900',
            warning: 'bg-amber-500 text-white',
            warning_light: 'bg-amber-100 text-amber-900',
            info:  'bg-sky-500 text-white',
            info_light: 'bg-sky-100 text-sky-900'
        };
        
        const notification = document.createElement('div');
        notification.className = `${colors[type]} px-4 py-3 rounded-lg shadow-lg flex items-start gap-3 transform transition-all duration-300 translate-x-full`;
        
        if (title) {
            notification.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-base mb-0.5">${title}</div>
                <div class="text-sm">${message}</div>
            </div>
            <button class="close-notification flex-shrink-0 p-1 hover:bg-black/10 rounded transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            `;
            timeout += 3000;
        } else {
            notification.innerHTML = `
            <span class="text-sm font-medium flex-1">${message}</span>
            <button class="close-notification flex-shrink-0 p-1 hover:bg-black/10 rounded transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            `;
        }
        
        container.appendChild(notification);
        
        // Close button functionality
        const closeBtn = notification.querySelector('.close-notification');
        closeBtn.addEventListener('click', () => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        });
        
        requestAnimationFrame(() => notification.classList.remove('translate-x-full'));
        
        // Auto-dismiss after timeout
        const autoDismiss = setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        }, timeout);
        
        // Clear auto-dismiss if manually closed
        closeBtn.addEventListener('click', () => clearTimeout(autoDismiss), { once: true });
    }



    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
        disconnectedUserStatus.forEach((_, id) => clearDisconnectTimer(id));
    });
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });

    settingModal = document.getElementById('settings-modal');
    settingModal.addEventListener('click', function(event) {
        if (event.target === settingModal) {
            OpenCloseSettings();
        }
    });


    // Tooltip Positioning
    const tooltipContainers = document.querySelectorAll('.tooltip-container');
    
    tooltipContainers.forEach(container => {
        const tooltip = container.querySelector('.tooltip-content');
        
        container.addEventListener('mouseenter', function() {
            const rect = container.getBoundingClientRect();
            tooltip.style.left = rect.left + (rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - 8) + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';
        });
    });

</script>

{% if is_host %}
    <script>
        showNotification('With Great Power Comes, Great Responsibility', 'success_light', position='top', title='‚≠ê!! You are the Host !!‚≠ê');
    </script>
{% endif %}

{% endblock %}