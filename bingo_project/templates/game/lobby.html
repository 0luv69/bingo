{% extends 'base.html' %}
{% load game_filters %}
{% load static %}

{% block title %}Lobby - {{ room.code }}{% endblock %}

{% block header %}
<div id="connection-status" class="badge badge-warning">Connecting...</div>
{% endblock %}

{% block extra_css %}
<style>
    .tooltip-container { position: relative; display: inline-flex; }
    .tooltip-content {
        visibility: hidden;
        width: 220px;
        background-color:  #1e293b;
        color: #fff;
        text-align: left;
        border-radius: 8px;
        padding: 10px 12px;
        position: absolute;
        z-index: 100;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
        font-size: 12px;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tooltip-content:: after {
        content: "";
        position: absolute;
        top:  100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
    }
    .tooltip-container:hover .tooltip-content { visibility: visible; opacity: 1; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-20 right-4 z-50 space-y-2 max-w-xs"></div>
    
    <!-- Main Content -->
    <main class="flex-1 py-8 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="grid lg:grid-cols-3 gap-6">
                
                <!-- Left Column:  Room Info & Share -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Room Code Card -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold text-slate-900">Room Code</h2>
                            {% if current_round %}
                            <span class="badge badge-info px-2 rounded-xl">Round {{ current_round.round_number }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center justify-center gap-4 py-4">
                            <span id="room-code" class="text-4xl font-mono font-bold text-slate-900 tracking-widest">{{ room.code }}</span>
                            <button 
                                onclick="copyRoomCode()"
                                class="p-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors"
                                title="Copy room code"
                            >
                                <svg id="copy-icon" class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <svg id="check-icon" class="w-5 h-5 text-emerald-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Share Options -->
                        <div class="flex flex-wrap gap-3 justify-center mt-4 pt-4 border-t border-slate-100">
                            <button onclick="copyShareLink()" class="btn-secondary flex items-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                </svg>
                                <span id="copy-link-text">Copy Link</span>
                            </button>
                            <button onclick="showQRCode()" class="btn-secondary flex items-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                QR Code
                            </button>
                        </div>
                    </div>
                    
                    <!-- Players Card -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold text-slate-900">Players</h2>
                            <span id="player-count" class="text-sm text-slate-400">{{ round_players|length }}/{{ room.settings_max_players }}</span>
                        </div>
                        
                        <div id="players-list" class="space-y-2">
                            {% for player in round_players %}
                            <div class="player-card flex items-center justify-between p-3 rounded-xl relative
                                {% if player.room_member.id == current_member.id %}bg-accent-50 border border-accent-100{% else %}bg-slate-50{% endif %}
                                {% if player.connection_status == 'disconnected' %} border border-dashed border-slate-900{% endif %}" 
                                data-member-id="{{ player.room_member.id }} ">
                                    <div class="flex items-center gap-3  {% if player.connection_status == 'disconnected' %}disconnected {% endif %}">
                                        <!--Disconnect Icon-->
                                        <span class="p-1 rounded-full bg-red-100 absolute -top-2 -left-2 {% if player.connection_status != 'disconnected' %} hidden {% endif %} " title="Player disconnected">
                                            <svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' class="w-5 h-5 text-red-700" >
                                                <g transform="matrix(0.69 0 0 0.69 12 12)" >
                                                    <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-17.59, -19.25)" d="M 16 6.5 C 10.984 6.5 6.4407812 8.565625 3.1757812 11.890625 L 4.5898438 13.304688 C 7.4918437 10.343687 11.535 8.5 16 8.5 C 20.465 8.5 24.508156 10.343687 27.410156 13.304688 L 28.824219 11.890625 C 25.559219 8.565625 21.016 6.5 16 6.5 z M 16 11.5 C 12.359 11.5 9.0699375 13.007781 6.7109375 15.425781 L 8.1210938 16.839844 C 10.121094 14.780844 12.914 13.5 16 13.5 C 17.682 13.5 19.272219 13.892266 20.699219 14.572266 C 21.628219 14.246266 22.617437 14.053578 23.648438 14.017578 C 21.501437 12.442578 18.864 11.5 16 11.5 z M 24 16 C 19.6 16 16 19.6 16 24 C 16 28.4 19.6 32 24 32 C 28.4 32 32 28.4 32 24 C 32 19.6 28.4 16 24 16 z M 16 16.5 C 13.738 16.5 11.699187 17.444938 10.242188 18.960938 L 11.65625 20.371094 C 12.67425 19.303094 14.078484 18.611531 15.646484 18.519531 C 16.109484 17.815531 16.662203 17.178281 17.283203 16.613281 C 16.864203 16.545281 16.438 16.5 16 16.5 z M 24 18 C 27.3 18 30 20.7 30 24 C 30 27.3 27.3 30 24 30 C 20.7 30 18 27.3 18 24 C 18 20.7 20.7 18 24 18 z M 21.699219 20.300781 L 20.300781 21.699219 L 22.599609 24 L 20.300781 26.300781 L 21.699219 27.699219 L 24 25.400391 L 26.300781 27.699219 L 27.699219 26.300781 L 25.400391 24 L 27.699219 21.699219 L 26.300781 20.300781 L 24 22.599609 L 21.699219 20.300781 z M 14.181641 22.132812 C 14.038641 22.243813 13.90225 22.362094 13.78125 22.496094 L 14.080078 22.794922 C 14.107078 22.571922 14.140641 22.350812 14.181641 22.132812 z" stroke-linecap="round" />
                                                </g>
                                            </svg>
                                        </span>

                                        <!-- Profile icon -->
                                        <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center">
                                            {% if player.is_host %}
                                                <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                </svg>
                                            {% else %}
                                                <span class="text-sm font-medium text-slate-500">{{ player.display_name|slice:": 1"|upper }}</span>
                                            {% endif %}
                                        </div>
                                        <!-- Player Info -->
                                        <div>
                                            <p class="font-medium text-slate-900 text-sm">
                                                {{ player.display_name }} 
                                                {% if player.room_member.id == current_member.id %}<span class="text-slate-400 font-normal">(You)</span>{% endif %}
                                            </p>
                                            <p class="text-xs text-slate-400">
                                                {% if player.room_member.user %} @{{ player.room_member.user.username }}{% else %}Guest{% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- Role Badge -->
                                        <div>
                                            {% if player.role == 'host' %}<span class="badge badge-warning px-1 rounded-md">Host</span>
                                            {% elif player.role == 'co-host' %}<span class="badge badge-info px-1 rounded-md">Co-Host</span>
                                            {%else%}<span class="badge badge-info px-1 rounded-md">Player</span>{% endif %}
                                        </div>
                                        
                                        {% if player.room_member.id != current_member.id %}
                                            {% if is_host or player.role == 'co-host' %}
                                                <button onclick="kickPlayer({{ player.room_member.id }}, '{{ player.display_name }}')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Kick player">
                                                    <!-- Kick Icon -->
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"  class="w-4 h-4" >
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM4 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 10.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                                                    </svg>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                            </div>
                            {% empty %}
                            <p class="text-slate-400 text-center py-4">No players yet</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Actions & Settings -->
                <div class="space-y-4">
                    <!-- Actions -->
                    <div class="card p-6">
                        <h2 class="font-semibold text-slate-900 mb-4">Actions</h2>
                        
                        <div class="space-y-3">
                            {% if is_host %}
                            <button id="start-game-btn" onclick="startGame()" class="w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed" {% if round_players|length < 2 %}disabled{% endif %}>
                                Start Game
                            </button>
                            <p id="start-hint" class="text-xs text-slate-400 text-center">
                                {% if round_players|length < 2 %}Need at least 2 players{% else %}Click to start when ready{% endif %}
                            </p>
                            {% else %}
                            <div class="text-center text-slate-500 text-sm py-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                Waiting for host to start the game...
                            </div>
                            {% endif %}
                            
                            <button onclick="showLeaveModal()" class="w-full btn-secondary text-red-600 hover:bg-red-50 border-red-200">
                                Leave Room
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="is-host" value="{{ is_host|yesno:'1,0' }}">
                  
                    <!-- Host Settings -->
                    {% if is_host %}
                    <div class="card p-6">
                        <div class="flex justify-between items-center gap-2 mb-4">
                            <h2 class="font-semibold text-slate-900">Game Settings</h2>
                            <span id="reset-settings-btn" title="Reset to Default settings" onclick="resetSettings()" class="p-1 rounded-full bg-rose-100 hover:bg-rose-200 text-rose-800 transition-colors cursor-pointer hidden">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </span>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Setup Duration -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Setup Time</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Setup Time</strong><br>
                                            Time players have to arrange their bingo board before the game starts. Drag numbers to customize your board layout.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="setup-duration" min="15" max="120" value="{{ room.settings_setup_duration }}" class="flex-1" oninput="updateDisplay('setup-duration')">
                                    <span id="setup-duration-display" class="text-sm font-medium w-12 text-right">{{ room.settings_setup_duration }}s</span>
                                </div>
                            </div>
                            
                            <!-- Turn Duration -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Turn Time</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Turn Time</strong><br>
                                            Time each player has to pick a number on their turn.If time runs out, a random number is auto-selected.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="turn-duration" min="10" max="60" value="{{ room.settings_turn_duration }}" class="flex-1" oninput="updateDisplay('turn-duration')">
                                    <span id="turn-duration-display" class="text-sm font-medium w-12 text-right">{{ room.settings_turn_duration }}s</span>
                                </div>
                            </div>
                            
                            <!-- Max Players -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Max Players</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Max Players</strong><br>
                                            Maximum number of players allowed in this room.New players cannot join once the limit is reached.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="max-players" min="2" max="15" value="{{ room.settings_max_players }}" class="flex-1" oninput="updateDisplay('max-players')">
                                    <span id="max-players-display" class="text-sm font-medium w-12 text-right">{{ room.settings_max_players }}</span>
                                </div>
                            </div>
                            
                            <!-- Grace Period -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Disconnect Grace</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Disconnect Grace Period</strong><br>
                                            Time to wait before taking action when a player disconnects.<br><br>
                                            â€¢ <strong>In Lobby/Setup:</strong> Vote kick starts after this time<br>
                                            â€¢ <strong>In Game:</strong> Bot takes over after this time
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="grace-period" min="5" max="60" value="{{ room.settings_grace_period }}" class="flex-1" oninput="updateDisplay('grace-period')">
                                    <span id="grace-period-display" class="text-sm font-medium w-12 text-right">{{ room.settings_grace_period }}s</span>
                                </div>
                            </div>
                            
                            <!-- Show Score -->
                            <div class="flex items-center justify-between pt-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-slate-600">Show Scores</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Show Scores</strong><br>
                                            When enabled, players can see how many lines other players have completed (BINGO progress).
                                        </div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="show-score" class="sr-only peer" {% if room.settings_show_score %}checked{% endif %} onclick="updateDisplay('show-score')">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                                </label>
                            </div>
                            
                            <button id="save-settings-btn" onclick="saveSettings()" class="w-full btn-primary text-sm mt-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Save Settings
                            </button>
                        </div>
                    </div>
                    {%else%}
                    <!-- Game settings (view only for non-hosts) -->
                    <div class="card p-6">
                        <div class="mb-4">
                        <h2 class="font-semibold text-slate-900 mb-1">Game Settings</h2>
                        <p class="text-red-500 text-[11px]">
                            Only Host and Co-Hosts can modify game settings. You can only view.
                        </p>
                        </div>

                        <div class="space-y-4">
                            <!-- Setup Duration -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Setup Time</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Setup Time</strong><br>
                                            Time players have to arrange their bingo board before the game starts.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="setup-duration" min="15" max="120" value="{{ room.settings_setup_duration }}" class="flex-1" disabled>
                                    <span id="setup-duration-display" class="text-sm font-medium w-12 text-right">{{ room.settings_setup_duration }}s</span>
                                </div>
                            </div>
                            
                            <!-- Turn Duration -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Turn Time</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Turn Time</strong><br>
                                            Time each player has to pick a number on their turn.If time runs out, a random number is auto-selected.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="turn-duration" min="10" max="60" value="{{ room.settings_turn_duration }}" class="flex-1" disabled>
                                    <span id="turn-duration-display" class="text-sm font-medium w-12 text-right">{{ room.settings_turn_duration }}s</span>
                                </div>
                            </div>
                            
                            <!-- Max Players -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Max Players</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Max Players</strong><br>
                                            Maximum number of players allowed in this room.New players cannot join once the limit is reached.
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="max-players" min="2" max="15" value="{{ room.settings_max_players }}" class="flex-1" disabled>
                                    <span id="max-players-display" class="text-sm font-medium w-12 text-right">{{ room.settings_max_players }}</span>
                                </div>
                            </div>
                            
                            <!-- Grace Period -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="text-sm text-slate-600">Disconnect Grace</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Disconnect Grace Period</strong><br>
                                            Time to wait before taking action when a player disconnects.<br><br>
                                            â€¢ <strong>In Lobby/Setup:</strong> Vote kick starts after this time<br>
                                            â€¢ <strong>In Game:</strong> Bot takes over after this time
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="range" id="grace-period" min="5" max="60" value="{{ room.settings_grace_period }}" class="flex-1" disabled>
                                    <span id="grace-period-display" class="text-sm font-medium w-12 text-right">{{ room.settings_grace_period }}s</span>
                                </div>
                            </div>
                            
                            <!-- Show Score -->
                            <div class="flex items-center justify-between pt-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-slate-600">Show Scores</label>
                                    <div class="tooltip-container">
                                        <svg class="w-4 h-4 text-slate-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="tooltip-content">
                                            <strong>Show Scores</strong><br>
                                            When enabled, players can see how many lines other players have completed (BINGO progress).
                                        </div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="show-score" class="sr-only peer" {% if room.settings_show_score %}checked{% endif %} disabled>
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Round History Card -->
                    {% if round_history %}
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-slate-900">Round History</h3>
                            <span class="text-xs text-slate-400">{{ round_history|length }} round{{ round_history|length|pluralize }}</span>
                        </div>
                        
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            {% for round in round_history %}
                            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full {% if round.winners %}bg-amber-100{% else %}bg-slate-200{% endif %} flex items-center justify-center">
                                       <span class= "text-xs font-medium text-amber-700 p-2">R{{ round.round_number }}</span>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400">
                                            {% if round.winners.exists %}
                                            ğŸ† {% for winner in round.winners.all %}{{ winner.display_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                            {% else %}
                                            No winner
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    {% if round.finished_at %}
                                    <p class="text-xs text-slate-400">{{ round.finished_at|timesince }} ago</p>
                                    {% endif %}
                                    <p class="text-xs text-slate-500">{{ round.called_numbers|length }} calls</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                                        
                </div>
                
            </div>
            
        </div>
    </main>
    
</div>


<!-- QR Code Modal -->
<div id="qr-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeModal('qr-modal', event)">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
        <h3 class="text-lg font-bold text-center mb-4">Scan to Join</h3>
        <div id="qr-code" class="flex justify-center mb-4"></div>
        <p class="text-sm text-slate-500 mb-4 text-center">Room:  {{ room.code }}</p>
        <button onclick="hideQRCode('qr-modal')" class="w-full btn-secondary">Close</button>
    </div>
</div>

<!-- Kick Confirm Modal -->
<div id="kick-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-sm mx-4">
        <h3 class="font-semibold text-slate-900 mb-2">Remove Player</h3>
        <p class="text-slate-500 mb-6">Remove <span id="kick-player-name" class="font-medium"></span> from the room?</p>
        <div class="flex gap-3">
            <button onclick="hideKickModal()" class="btn-secondary flex-1">Cancel</button>
            <button onclick="confirmKick()" class="btn-primary flex-1 bg-red-500 hover:bg-red-600">Remove</button>
        </div>
    </div>
</div>

<!-- Leave Room Modal -->
<div id="leave-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeModal('leave-modal', event)">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900">Leave Room</h3>
            <p class="text-slate-600 mt-2">Are you sure you want to leave this room?</p>
            {% if current_member.is_host %}
            <p class="text-amber-600 text-sm mt-2">As host, leadership will transfer to another player.</p>
            {% endif %}
        </div>
        <div class="flex gap-3">
            <button onclick="closeModal('leave-modal')" class="flex-1 btn-secondary">Stay</button>
            <button onclick="confirmLeave()" class="flex-1 btn-primary bg-red-500 hover:bg-red-600">Leave</button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const roomCode = "{{ room.code }}";
    const currentMemberId = {{ current_member.id }};
    const isHost = {{ is_host|yesno:"true,false" }};
    const shareUrl = "{{ share_url }}";
    
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let kickTargetId = null;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEBSOCKET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/room/${roomCode}/`;
        
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            updateConnectionStatus('connected');
        };
        
        socket.onclose = function() {
            console.log('WebSocket disconnected');
            updateConnectionStatus('disconnected');
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 2000);
            }
        };
        
        socket.onerror = function(e) {
            console.error('WebSocket error:', e);
            updateConnectionStatus('error');
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received:', data);
            handleMessage(data);
        };
    }
    
    function sendMessage(type, payload = {}) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type, ...payload }));
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MESSAGE HANDLERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function handleMessage(data) {
        switch (data.type) {
            case 'player_connected':
                updatePlayersList(data.round_players);
                if (data.member_id !== currentMemberId) {
                    showNotification(`${data.member_name} joined`, 'success');
                }
                break;
            case 'player_disconnected':
                if (data.member_id !== currentMemberId) {
                    showNotification(`${data.member_name} disconnected`, 'info');
                }
                break;
            
            case 'player_left':
                updatePlayersList(data.round_players);
                if (data.was_host && data.new_host_name) {
                    showNotification(`${data.new_host_name} is now the host, ${data.member_name} Left Room.`, 'info');
                    // Reload if we became host
                    setTimeout(() => location.reload(), 1000);
                }else{
                    showNotification(`${data.member_name} left the room`, 'info');
                }
                break;
            

            case 'player_kicked':
                if (data.kicked_member_id === currentMemberId) {
                    showNotification('You have been removed from the room', 'error');
                    setTimeout(() => window.location.href = '/', 2000);
                } else {
                    updatePlayersList(data.round_players);
                    showNotification(`${data.kicked_name} was removed`, 'info');
                }
                break;

            case 'game_starting':
                showNotification(data.message, 'success');
                setTimeout(() => window.location.href = `/room/${roomCode}/game/`, 1000);
                break;
            case 'settings_updated':
                settingsUpdate(data.settings);
                showNotification(`Settings updated by ${data.updated_by}`, 'info');
                break;
            case 'new_round_created':
                showNotification(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
                break;
            case 'leave_confirmed':
                window.location.href = data.redirect_url;
                break;            
            
            case 'error':
                showNotification(data.message, 'error');
                break;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI UPDATES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateConnectionStatus(status) {
        const el = document.getElementById('connection-status');
        el.className = 'badge';
        if (status === 'connected') {
            el.classList.add('badge-success');
            el.textContent = 'Connected';
        } else if (status === 'disconnected') {
            el.classList.add('badge-warning');
            el.textContent = 'Reconnecting...';
        } else {
            el.classList.add('badge-warning');
            el.textContent = 'Error';
        }
    }
    
    function updatePlayersList(players) {
        const container = document.getElementById('players-list');
        const countEl = document.getElementById('player-count');
        const startBtn = document.getElementById('start-game-btn');
        const startHint = document.getElementById('start-hint');
        
        if (countEl) {
            countEl.textContent = `${players.length}/${document.getElementById('max-players')?.value || 6}`;
        }
        
        if (startBtn && isHost) {
            startBtn.disabled = players.length < 2;
            if (startHint) {
                startHint.textContent = players.length < 2 ? 'Need at least 2 players' : 'Click to start when ready';
            }
        }
        
        const crownSvg = `<svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
        
        container.innerHTML = players.map(player => {
            const isMe = player.member_id === currentMemberId;
            const roleText = player.role === 'host' ?  'Host' : player.role === 'co-host' ? 'Co-Host' : 'Player';
            
            return `
                <div class="player-card flex items-center justify-between p-3 rounded-xl relative
                ${isMe ? 'bg-accent-50 border border-accent-100' : 'bg-slate-50'} 
                ${player.connection_status === 'disconnected' ? 'border border-dashed border-slate-900' : ''}" 
                data-member-id="${player.member_id}">
                    <div class="flex items-center gap-3 ${player.connection_status === 'disconnected' ? 'disconnected' : ''}">
                        <!--Disconnect Icon-->
                        <span class="p-1 rounded-full bg-red-100 absolute -top-2 -left-2 ${ player.connection_status !== 'disconnected' ? 'hidden' : '' }" title="Player disconnected">
                            <svg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' class="w-5 h-5 text-red-700" >
                                <g transform="matrix(0.69 0 0 0.69 12 12)" >
                                    <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-17.59, -19.25)" d="M 16 6.5 C 10.984 6.5 6.4407812 8.565625 3.1757812 11.890625 L 4.5898438 13.304688 C 7.4918437 10.343687 11.535 8.5 16 8.5 C 20.465 8.5 24.508156 10.343687 27.410156 13.304688 L 28.824219 11.890625 C 25.559219 8.565625 21.016 6.5 16 6.5 z M 16 11.5 C 12.359 11.5 9.0699375 13.007781 6.7109375 15.425781 L 8.1210938 16.839844 C 10.121094 14.780844 12.914 13.5 16 13.5 C 17.682 13.5 19.272219 13.892266 20.699219 14.572266 C 21.628219 14.246266 22.617437 14.053578 23.648438 14.017578 C 21.501437 12.442578 18.864 11.5 16 11.5 z M 24 16 C 19.6 16 16 19.6 16 24 C 16 28.4 19.6 32 24 32 C 28.4 32 32 28.4 32 24 C 32 19.6 28.4 16 24 16 z M 16 16.5 C 13.738 16.5 11.699187 17.444938 10.242188 18.960938 L 11.65625 20.371094 C 12.67425 19.303094 14.078484 18.611531 15.646484 18.519531 C 16.109484 17.815531 16.662203 17.178281 17.283203 16.613281 C 16.864203 16.545281 16.438 16.5 16 16.5 z M 24 18 C 27.3 18 30 20.7 30 24 C 30 27.3 27.3 30 24 30 C 20.7 30 18 27.3 18 24 C 18 20.7 20.7 18 24 18 z M 21.699219 20.300781 L 20.300781 21.699219 L 22.599609 24 L 20.300781 26.300781 L 21.699219 27.699219 L 24 25.400391 L 26.300781 27.699219 L 27.699219 26.300781 L 25.400391 24 L 27.699219 21.699219 L 26.300781 20.300781 L 24 22.599609 L 21.699219 20.300781 z M 14.181641 22.132812 C 14.038641 22.243813 13.90225 22.362094 13.78125 22.496094 L 14.080078 22.794922 C 14.107078 22.571922 14.140641 22.350812 14.181641 22.132812 z" stroke-linecap="round" />
                                </g>
                            </svg>
                        </span>

                        <!-- Profile icon -->
                        <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center">
                            ${player.is_host ? crownSvg : `<span class="text-sm font-medium text-slate-500">${player.name.charAt(0).toUpperCase()}</span>`}
                        </div>

                        <!-- Player Info -->
                        <div>
                            <p class="font-medium text-slate-900 text-sm">
                                ${player.name}${isMe ? '<span class="text-slate-400 font-normal"> (You)</span>' : ''}
                            </p>
                            <p class="text-xs text-slate-400">${ player.user ? `@${player.user.username}` : 'Guest Player'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Role Badge -->
                        <div>
                            ${player.is_host 
                                ? '<span class="badge badge-warning px-1 rounded-md">Host</span>' 
                                : player.role === 'co-host'
                                    ? '<span class="badge badge-info px-1 rounded-md">Co-Host</span>'
                                    : '<span class="badge badge-info px-1 rounded-md">Player</span>'
                            }
                        </div>
                        ${isHost && ! isMe ? `
                            <button onclick="kickPlayer(${player.member_id}, '${player.name}')" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Kick player">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"  class="w-4 h-4" >
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM4 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 10.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function startGame() {
        sendMessage('start_game');
    }

    function resetSettings() {
        document.getElementById('setup-duration').value = 60;
        document.getElementById('turn-duration').value = 20;
        document.getElementById('max-players').value = 8;
        document.getElementById('grace-period').value = 15;
        document.getElementById('show-score').checked = false;
        
        updateDisplay('setup-duration');
        updateDisplay('turn-duration');
        updateDisplay('max-players');
        updateDisplay('grace-period');
        showNotification('Settings reset to default', 'success_light');
        
        document.getElementById('reset-settings-btn').classList.add('hidden');
        setting_btn = document.getElementById('save-settings-btn')
        setting_btn.disabled = true;
    }

    function updateDisplay(settingId, btn_change = true) {
        if (settingId != 'show-score') {
            const input = document.getElementById(settingId);
            const display = document.getElementById(`${settingId}-display`);
            display.textContent = `${input.value}${settingId.includes('duration') || settingId === 'grace-period' ? 's' : ''}`;
        } else {
            const checkbox = document.getElementById('show-score');
            checkbox.value = checkbox.checked ? 'true' : 'false';
        }
        
        if (btn_change) {
            setting_btn = document.getElementById('save-settings-btn')
            setting_btn.disabled = false;
            document.getElementById('reset-settings-btn').classList.remove('hidden');
        }

    }
    
    function saveSettings() {
        const settings = {
            setup_duration:  parseInt(document.getElementById('setup-duration').value),
            turn_duration: parseInt(document.getElementById('turn-duration').value),
            max_players: parseInt(document.getElementById('max-players').value),
            grace_period: parseInt(document.getElementById('grace-period').value),
            show_score: document.getElementById('show-score').value === 'true'
        };
        setting_btn = document.getElementById('save-settings-btn')
        setting_btn.disabled = true;

        document.getElementById('reset-settings-btn').classList.add('hidden');

        sendMessage('update_settings', { settings });
        showNotification('Settings saved', 'success');
    }

    function settingsUpdate(data){
        is_host = document.getElementById('is-host').value === 'true';
        if (! is_host){
            document.getElementById('setup-duration').value = data.setup_duration;
            document.getElementById('turn-duration').value = data.turn_duration;
            document.getElementById('max-players').value = data.max_players;
            document.getElementById('grace-period').value = data.grace_period;
            document.getElementById('show-score').checked = data.show_score;

            updateDisplay('setup-duration', false);
            updateDisplay('turn-duration', false);
            updateDisplay('max-players', false);
            updateDisplay('grace-period', false);
        }
    }
    
    function copyRoomCode() {
        navigator.clipboard.writeText(roomCode).then(() => {
            document.getElementById('copy-icon').classList.add('hidden');
            document.getElementById('check-icon').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('copy-icon').classList.remove('hidden');
                document.getElementById('check-icon').classList.add('hidden');
            }, 2000);
        });
        showNotification('Room code copied! ', 'success_light');
    }
    
    function copyShareLink() {
        const fullUrl = shareUrl;
        navigator.clipboard.writeText(fullUrl).then(() => {
            document.getElementById('copy-link-text').textContent = 'Copied!';
            setTimeout(() => document.getElementById('copy-link-text').textContent = 'Copy Link', 2000);
        });
        showNotification('Share link copied! ', 'success_light');
    }
    
    function showQRCode() {
        const modal = document.getElementById('qr-modal');
        const qrContainer = document.getElementById('qr-code');
        qrContainer.innerHTML = '';

        const fullUrl =  shareUrl;

        QRCode.toCanvas(fullUrl, { width: 200 }, (err, canvas) => {
            if (! err) qrContainer.appendChild(canvas);
        });


        modal.classList.remove('hidden');
    }
    
    function hideQRCode() {
        document.getElementById('qr-modal').classList.add('hidden');
    }
    
    function kickPlayer(memberId, name) {
        kickTargetId = memberId;
        document.getElementById('kick-player-name').textContent = name;
        document.getElementById('kick-modal').classList.remove('hidden');
    }
    
    function hideKickModal() {
        document.getElementById('kick-modal').classList.add('hidden');
        kickTargetId = null;
    }
    
    function confirmKick() {
        if (kickTargetId) {
            sendMessage('kick_player', { member_id: kickTargetId });
        }
        hideKickModal();
    }
    
        
    function showModal(id) {
        document.getElementById(id).classList.remove('hidden');
    }
    
    function closeModal(id, event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById(id).classList.add('hidden');
    }

    function showLeaveModal(id) {
        showModal('leave-modal');
    }
    
    function confirmLeave() {
        sendMessage('leave_room');
    }

    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTIFICATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        
        const colors = {
            success: 'bg-emerald-500 text-white',
            success_light: 'bg-emerald-100 text-emerald-900',
            error:  'bg-red-500 text-white',
            error_light: 'bg-red-100 text-red-900',
            warning: 'bg-amber-500 text-white',
            warning_light: 'bg-amber-100 text-amber-900',
            info:  'bg-sky-500 text-white',
            info_light: 'bg-sky-100 text-sky-900'
        };
        
        const notification = document.createElement('div');
        notification.className = `${colors[type]}  px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform transition-all duration-300 translate-x-full`;
        notification.innerHTML = `<span class="text-sm font-medium">${message}</span>`;
        
        container.appendChild(notification);
        
        requestAnimationFrame(() => notification.classList.remove('translate-x-full'));
        
        setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
        disconnectedTimers.forEach((_, id) => clearDisconnectTimer(id));
    });
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });
</script>
{% endblock %}